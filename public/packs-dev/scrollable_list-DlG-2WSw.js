var W=Object.defineProperty;var O=(n,s,e)=>s in n?W(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var i=(n,s,e)=>O(n,typeof s!="symbol"?s+"":s,e);import{j as l}from"./client-BG6VvM0b.js";import{r as a}from"./index-ykyyQSL-.js";import{c as v}from"./index-guCj-HqV.js";import{j as E,cI as R,cJ as k,cK as V,cL as P,bX as w,bT as F}from"./useSelectableClick-DBo53LOf.js";import{a as S}from"./index-DHslUCy5.js";import{S as A}from"./scroll_container-BQpJ36fQ.js";import{s as x}from"./schedule_idle_task-CTsEu-tt.js";import{L as K}from"./load_more-BJ-OkDO5.js";import{M as U}from"./message-Bb0z64dP.js";import{L as $}from"./loading_indicator-BBuNQ1GS.js";import{u as z}from"./short_number--sxn3OKQ.js";let N;function J(n){if(typeof N!="boolean"){const s=n.target.getBoundingClientRect(),e=n.boundingClientRect;N=s.height!==e.height||s.top!==e.top||s.width!==e.width||s.bottom!==e.bottom||s.left!==e.left||s.right!==e.right}return N?n.target.getBoundingClientRect():n.boundingClientRect}const X=["id","index","listLength","cachedHeight"];class Y extends a.Component{constructor(){super(...arguments);i(this,"state",{isHidden:!1});i(this,"handleIntersection",e=>{this.entry=e,x(this.calculateHeight),this.setState(this.updateStateAfterIntersection)});i(this,"updateStateAfterIntersection",e=>(e.isIntersecting!==!1&&!this.entry.isIntersecting&&x(this.hideIfNotIntersecting),{isIntersecting:this.entry.isIntersecting,isHidden:!1}));i(this,"calculateHeight",()=>{const{onHeightChange:e,saveHeightKey:t,id:o}=this.props;this.height=J(this.entry).height,e&&t&&e(t,o,this.height)});i(this,"hideIfNotIntersecting",()=>{this.componentMounted&&this.setState(e=>({isHidden:!e.isIntersecting}))});i(this,"handleRef",e=>{this.node=e})}shouldComponentUpdate(e,t){const o=!this.state.isIntersecting&&(this.state.isHidden||this.props.cachedHeight),r=!t.isIntersecting&&(t.isHidden||e.cachedHeight);return!!o!=!!r?!0:o?!X.every(c=>e[c]===this.props[c]):!0}componentDidMount(){const{intersectionObserverWrapper:e,id:t}=this.props;e.observe(t,this.node,this.handleIntersection),this.componentMounted=!0}componentWillUnmount(){const{intersectionObserverWrapper:e,id:t}=this.props;e.unobserve(t,this.node),this.componentMounted=!1}render(){const{children:e,id:t,index:o,listLength:r,cachedHeight:c}=this.props,{isIntersecting:h,isHidden:d}=this.state;return!h&&(d||c)?l.jsxDEV("article",{ref:this.handleRef,"aria-posinset":o+1,"aria-setsize":r,style:{height:`${this.height||c}px`,opacity:0,overflow:"hidden"},"data-id":t,tabIndex:-1,children:e&&a.cloneElement(e,{hidden:!0})},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/intersection_observer_article.jsx",lineNumber:111,columnNumber:9},this):l.jsxDEV("article",{ref:this.handleRef,"aria-posinset":o+1,"aria-setsize":r,"data-id":t,tabIndex:-1,children:e&&a.cloneElement(e,{hidden:!1})},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/intersection_observer_article.jsx",lineNumber:125,columnNumber:7},this)}}const q=(n,s)=>({cachedHeight:n.getIn(["height_cache",s.saveHeightKey,s.id])}),G=n=>({onHeightChange(s,e,t){n(R(s,e,t))}}),Q=E(q,G)(Y);class Z{constructor(){i(this,"callbacks",{});i(this,"observerBacklog",[]);i(this,"observer",null)}connect(s){const e=t=>{t.forEach(o=>{const r=o.target.getAttribute("data-id");this.callbacks[r]&&this.callbacks[r](o)})};this.observer=new IntersectionObserver(e,s),this.observerBacklog.forEach(([t,o,r])=>{this.observe(t,o,r)}),this.observerBacklog=null}observe(s,e,t){this.observer?(this.callbacks[s]=t,this.observer.observe(e)):this.observerBacklog.push([s,e,t])}unobserve(s,e){this.observer&&(delete this.callbacks[s],this.observer.unobserve(e))}disconnect(){this.observer&&(this.callbacks={},this.observer.disconnect(),this.observer=null)}}const ee=({onClick:n,count:s})=>l.jsxDEV("button",{className:"load-more load-gap",onClick:n,children:l.jsxDEV(U,{id:"load_pending",defaultMessage:"{count, plural, one {# new item} other {# new items}}",values:{count:s}},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/load_pending.tsx",lineNumber:11,columnNumber:7},void 0)},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/load_pending.tsx",lineNumber:10,columnNumber:5},void 0),M=300,u=F?{passive:!0}:!1,te=(n,{scrollKey:s})=>({preventScroll:s===n.dropdownMenu.scrollKey}),se=({id:n,index:s,listLength:e,intersectionObserverWrapper:t,trackScroll:o,scrollKey:r,children:c})=>{const h=z();return l.jsxDEV(Q,{id:n,index:s,listLength:e,intersectionObserverWrapper:t,saveHeightKey:o?`${h.key}:${r}`:null,children:c},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:42,columnNumber:10},void 0)};class L extends a.PureComponent{constructor(){super(...arguments);i(this,"state",{fullscreen:null,cachedMediaWidth:250});i(this,"intersectionObserverWrapper",new Z);i(this,"handleScroll",S(()=>{if(this.node){const e=this.getScrollTop(),t=this.getScrollHeight(),o=this.getClientHeight(),r=t-e-o;e>0&&r<400&&this.props.onLoadMore&&this.props.hasMore&&!this.props.isLoading&&this.props.onLoadMore(),e<100&&this.props.onScrollToTop?this.props.onScrollToTop():this.props.onScroll&&this.props.onScroll(),this.lastScrollWasSynthetic||(this.scrollToTopOnMouseIdle=!1),this.lastScrollWasSynthetic=!1}},150,{trailing:!0}));i(this,"mouseIdleTimer",null);i(this,"mouseMovedRecently",!1);i(this,"lastScrollWasSynthetic",!1);i(this,"scrollToTopOnMouseIdle",!1);i(this,"_getScrollingElement",()=>this.props.bindToDocument?document.scrollingElement||document.body:this.node);i(this,"setScrollTop",e=>{this.getScrollTop()!==e&&(this.lastScrollWasSynthetic=!0,this._getScrollingElement().scrollTop=e)});i(this,"clearMouseIdleTimer",()=>{this.mouseIdleTimer!==null&&(clearTimeout(this.mouseIdleTimer),this.mouseIdleTimer=null)});i(this,"handleMouseMove",S(()=>{this.clearMouseIdleTimer(),this.mouseIdleTimer=setTimeout(this.handleMouseIdle,M),!this.mouseMovedRecently&&this.getScrollTop()===0&&(this.scrollToTopOnMouseIdle=!0),this.mouseMovedRecently=!0},M/2));i(this,"handleWheel",S(()=>{this.scrollToTopOnMouseIdle=!1},150,{trailing:!0}));i(this,"handleMouseIdle",()=>{this.scrollToTopOnMouseIdle&&!this.props.preventScroll&&this.setScrollTop(0),this.mouseMovedRecently=!1,this.scrollToTopOnMouseIdle=!1});i(this,"getScrollPosition",()=>this.node&&(this.getScrollTop()>0||this.mouseMovedRecently)?{height:this.getScrollHeight(),top:this.getScrollTop()}:null);i(this,"getScrollTop",()=>this._getScrollingElement().scrollTop);i(this,"getScrollHeight",()=>this._getScrollingElement().scrollHeight);i(this,"getClientHeight",()=>this._getScrollingElement().clientHeight);i(this,"updateScrollBottom",e=>{const t=this.getScrollHeight()-e;this.setScrollTop(t)});i(this,"cacheMediaWidth",e=>{e&&this.state.cachedMediaWidth!==e&&this.setState({cachedMediaWidth:e})});i(this,"onFullScreenChange",()=>{this.setState({fullscreen:P()})});i(this,"setRef",e=>{this.node=e});i(this,"handleLoadMore",e=>{e.preventDefault(),this.props.onLoadMore()});i(this,"handleLoadPending",e=>{e.preventDefault(),this.props.onLoadPending(),this.scrollToTopOnMouseIdle=!1,this.lastScrollWasSynthetic=!1,this.clearMouseIdleTimer(),this.mouseIdleTimer=setTimeout(this.handleMouseIdle,M),this.mouseMovedRecently=!0})}componentDidMount(){this.attachScrollListener(),this.attachIntersectionObserver(),k(this.onFullScreenChange),this.handleScroll()}getSnapshotBeforeUpdate(e){const t=a.Children.count(e.children)>0&&a.Children.count(e.children)<a.Children.count(this.props.children)&&this.getFirstChildKey(e)!==this.getFirstChildKey(this.props);return e.numPending>0!=this.props.numPending>0||t&&(this.getScrollTop()>0||this.mouseMovedRecently||this.props.preventScroll)?this.getScrollHeight()-this.getScrollTop():null}componentDidUpdate(e,t,o){o!==null&&this.setScrollTop(this.getScrollHeight()-o)}componentWillUnmount(){this.clearMouseIdleTimer(),this.detachScrollListener(),this.detachIntersectionObserver(),V(this.onFullScreenChange)}attachIntersectionObserver(){let e={root:this.node,rootMargin:"300% 0px"};this.intersectionObserverWrapper.connect(this.props.bindToDocument?{}:e)}detachIntersectionObserver(){this.intersectionObserverWrapper.disconnect()}attachScrollListener(){this.props.bindToDocument?(document.addEventListener("scroll",this.handleScroll),document.addEventListener("wheel",this.handleWheel,u)):(this.node.addEventListener("scroll",this.handleScroll),this.node.addEventListener("wheel",this.handleWheel,u))}detachScrollListener(){this.props.bindToDocument?(document.removeEventListener("scroll",this.handleScroll),document.removeEventListener("wheel",this.handleWheel,u)):(this.node.removeEventListener("scroll",this.handleScroll),this.node.removeEventListener("wheel",this.handleWheel,u))}getFirstChildKey(e){const{children:t}=e;let o=t;return t instanceof w?o=t.get(0):Array.isArray(t)&&(o=t[0]),o&&o.key}render(){const{children:e,scrollKey:t,className:o,trackScroll:r,showLoading:c,isLoading:h,hasMore:d,numPending:p,prepend:g,alwaysPrepend:y,append:C,footer:f,emptyMessage:I,onLoadMore:H}=this.props,{fullscreen:T}=this.state,j=a.Children.count(e),_=d&&H?l.jsxDEV(K,{visible:!h,onClick:this.handleLoadMore},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:333,columnNumber:46},this):null,B=p>0?l.jsxDEV(ee,{count:p,onClick:this.handleLoadPending},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:334,columnNumber:42},this):null;let m=null;return c?m=l.jsxDEV("div",{className:"scrollable scrollable--flex",ref:this.setRef,children:[g,l.jsxDEV("div",{role:"feed",className:"item-list"},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:342,columnNumber:11},this),l.jsxDEV("div",{className:"scrollable__append",children:l.jsxDEV($,{},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:345,columnNumber:13},this)},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:344,columnNumber:11},this),f]},void 0,!0,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:339,columnNumber:7},this):h||j>0||p>0||d||!I?m=l.jsxDEV("div",{className:v("scrollable scrollable--flex",{fullscreen:T}),ref:this.setRef,onMouseMove:this.handleMouseMove,children:[g,l.jsxDEV("div",{role:"feed",className:v("item-list",o),children:[B,a.Children.map(this.props.children,(b,D)=>l.jsxDEV(se,{id:b.key,index:D,listLength:j,intersectionObserverWrapper:this.intersectionObserverWrapper,trackScroll:r,scrollKey:t,children:a.cloneElement(b,{getScrollPosition:this.getScrollPosition,updateScrollBottom:this.updateScrollBottom,cachedMediaWidth:this.state.cachedMediaWidth,cacheMediaWidth:this.cacheMediaWidth})},b.key,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:360,columnNumber:11},this)),_,!d&&C]},void 0,!0,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:356,columnNumber:11},this),f]},void 0,!0,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:353,columnNumber:7},this):m=l.jsxDEV("div",{className:v("scrollable scrollable--flex",{fullscreen:T}),ref:this.setRef,children:[y&&g,l.jsxDEV("div",{className:"empty-column-indicator",children:I},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:391,columnNumber:11},this),f]},void 0,!0,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:388,columnNumber:7},this),r?l.jsxDEV(A,{scrollKey:t,children:m},void 0,!1,{fileName:"/home/liam-esia/Bureau/github/mastodon/app/javascript/mastodon/components/scrollable_list.jsx",lineNumber:402,columnNumber:9},this):m}}i(L,"defaultProps",{trackScroll:!0});const ge=E(te,null,null,{forwardRef:!0})(L);export{ge as S};
//# sourceMappingURL=scrollable_list-DlG-2WSw.js.map
