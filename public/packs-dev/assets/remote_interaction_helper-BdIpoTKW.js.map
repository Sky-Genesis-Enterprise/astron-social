{"version":3,"file":"remote_interaction_helper-BdIpoTKW.js","sources":["../../../app/javascript/entrypoints/remote_interaction_helper.ts"],"sourcesContent":["/*\n\nThis script is meant to to be used in an `iframe` with the sole purpose of doing webfinger queries\nclient-side without being restricted by a strict `connect-src` Content-Security-Policy directive.\n\nIt communicates with the parent window through message events that are authenticated by origin,\nand performs no other task.\n\n*/\n\nimport axios from 'axios';\n\ninterface JRDLink {\n  rel: string;\n  template?: string;\n  href?: string;\n}\n\nconst isJRDLink = (link: unknown): link is JRDLink =>\n  typeof link === 'object' &&\n  link !== null &&\n  'rel' in link &&\n  typeof link.rel === 'string' &&\n  (!('template' in link) || typeof link.template === 'string') &&\n  (!('href' in link) || typeof link.href === 'string');\n\nconst findLink = (rel: string, data: unknown): JRDLink | undefined => {\n  if (\n    typeof data === 'object' &&\n    data !== null &&\n    'links' in data &&\n    data.links instanceof Array\n  ) {\n    return data.links.find(\n      (link): link is JRDLink => isJRDLink(link) && link.rel === rel,\n    );\n  } else {\n    return undefined;\n  }\n};\n\nconst findTemplateLink = (data: unknown) =>\n  findLink('http://ostatus.org/schema/1.0/subscribe', data)?.template;\n\nconst fetchInteractionURLSuccess = (\n  uri_or_domain: string,\n  template: string,\n) => {\n  window.parent.postMessage(\n    {\n      type: 'fetchInteractionURL-success',\n      uri_or_domain,\n      template,\n    },\n    window.origin,\n  );\n};\n\nconst fetchInteractionURLFailure = () => {\n  window.parent.postMessage(\n    {\n      type: 'fetchInteractionURL-failure',\n    },\n    window.origin,\n  );\n};\n\nconst isValidDomain = (value: unknown) => {\n  if (typeof value !== 'string') return false;\n\n  const url = new URL('https:///path');\n  url.hostname = value;\n  return url.hostname === value;\n};\n\n// Attempt to find a remote interaction URL from a domain\nconst fromDomain = (domain: string) => {\n  const fallbackTemplate = `https://${domain}/authorize_interaction?uri={uri}`;\n\n  axios\n    .get(`https://${domain}/.well-known/webfinger`, {\n      params: { resource: `https://${domain}` },\n    })\n    .then(({ data }) => {\n      const template = findTemplateLink(data);\n      fetchInteractionURLSuccess(domain, template ?? fallbackTemplate);\n      return;\n    })\n    .catch(() => {\n      fetchInteractionURLSuccess(domain, fallbackTemplate);\n    });\n};\n\n// Attempt to find a remote interaction URL from an arbitrary URL\nconst fromURL = (url: string) => {\n  const domain = new URL(url).host;\n  const fallbackTemplate = `https://${domain}/authorize_interaction?uri={uri}`;\n\n  axios\n    .get(`https://${domain}/.well-known/webfinger`, {\n      params: { resource: url },\n    })\n    .then(({ data }) => {\n      const template = findTemplateLink(data);\n      fetchInteractionURLSuccess(url, template ?? fallbackTemplate);\n      return;\n    })\n    .catch(() => {\n      fromDomain(domain);\n    });\n};\n\n// Attempt to find a remote interaction URL from a `user@domain` string\nconst fromAcct = (acct: string) => {\n  acct = acct.replace(/^@/, '');\n\n  const segments = acct.split('@');\n\n  if (segments.length !== 2 || !segments[0] || !isValidDomain(segments[1])) {\n    fetchInteractionURLFailure();\n    return;\n  }\n\n  const domain = segments[1];\n  const fallbackTemplate = `https://${domain}/authorize_interaction?uri={uri}`;\n\n  if (!domain) {\n    fetchInteractionURLFailure();\n    return;\n  }\n\n  axios\n    .get(`https://${domain}/.well-known/webfinger`, {\n      params: { resource: `acct:${acct}` },\n    })\n    .then(({ data }) => {\n      const template = findTemplateLink(data);\n      fetchInteractionURLSuccess(acct, template ?? fallbackTemplate);\n      return;\n    })\n    .catch(() => {\n      // TODO: handle host-meta?\n      fromDomain(domain);\n    });\n};\n\nconst fetchInteractionURL = (uri_or_domain: string) => {\n  if (uri_or_domain === '') {\n    fetchInteractionURLFailure();\n  } else if (/^https?:\\/\\//.test(uri_or_domain)) {\n    fromURL(uri_or_domain);\n  } else if (uri_or_domain.includes('@')) {\n    fromAcct(uri_or_domain);\n  } else {\n    fromDomain(uri_or_domain);\n  }\n};\n\nwindow.addEventListener('message', (event: MessageEvent<unknown>) => {\n  // Check message origin\n  if (\n    !window.origin ||\n    window.parent !== event.source ||\n    event.origin !== window.origin\n  ) {\n    return;\n  }\n\n  if (\n    event.data &&\n    typeof event.data === 'object' &&\n    'type' in event.data &&\n    event.data.type === 'fetchInteractionURL' &&\n    'uri_or_domain' in event.data &&\n    typeof event.data.uri_or_domain === 'string'\n  ) {\n    fetchInteractionURL(event.data.uri_or_domain);\n  }\n});\n"],"names":["isJRDLink","link","rel","template","href","findLink","data","links","Array","find","findTemplateLink","fetchInteractionURLSuccess","uri_or_domain","window","parent","postMessage","type","origin","fetchInteractionURLFailure","isValidDomain","value","url","URL","hostname","fromDomain","domain","fallbackTemplate","axios","get","params","resource","then","catch","fromURL","host","fromAcct","acct","replace","segments","split","length","fetchInteractionURL","test","includes","addEventListener","event","source"],"mappings":"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"}