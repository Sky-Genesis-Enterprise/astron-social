import{g as $}from"./load_locale-C-B7BkCQ.js";import"./client-BG6VvM0b.js";import{a as _,g as N}from"./index-ykyyQSL-.js";import{u as x}from"./initial_state-BP3UcUr4.js";import{au as G,av as R,aw as B,ax as M,ay as j,az as J,aA as P,aB as W,aC as D,aD as L,aE as A,aF as I,aG as q,aH as F,aI as H,aJ as z,N as K,aK as U,aL as V}from"./useSelectableClick-DBo53LOf.js";var d={},y={},v;function Y(){if(v)return y;v=1,Object.defineProperty(y,"__esModule",{value:!0}),y.createBackoff=s;var e={exponential:function(c,i){return Math.floor(Math.random()*Math.pow(2,c)*i)},fibonacci:function(c,i){var n=1;if(c>n)for(var t=1,n=2,r=2;r<c;r++){var l=t+n;t=n,n=l}return Math.floor(Math.random()*n*i)}};function s(o,c){return new a(e[o],c)}function a(o,c){this.func=o,this.attempts=0,this.delay=typeof c.initialDelay<"u"?c.initialDelay:100}return a.prototype.backoff=function(){setTimeout(this.onReady,this.func(++this.attempts,this.delay))},y}const Q=new Proxy({},{get(e,s){throw new Error(`Module "" has been externalized for browser compatibility. Cannot access ".${s}" in client code.  See https://vite.dev/guide/troubleshooting.html#module-externalized-for-browser-compatibility for more details.`)}}),X=Object.freeze(Object.defineProperty({__proto__:null,default:Q},Symbol.toStringTag,{value:"Module"})),Z=_(X);var w;function ee(){if(w)return d;w=1,Object.defineProperty(d,"__esModule",{value:!0});var e=function(){function i(n,t){for(var r=0;r<t.length;r++){var l=t[r];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(n,l.key,l)}}return function(n,t,r){return t&&i(n.prototype,t),r&&i(n,r),n}}();function s(i,n){if(!(i instanceof n))throw new TypeError("Cannot call a class as a function")}var a=Y().createBackoff,o=typeof WebSocket<"u"?WebSocket:Z,c=function(){function i(n,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};s(this,i),this.url=n,this.protocols=t,this.reconnectEnabled=!0,this.listeners={},this.backoff=a(r.backoff||"exponential",r),this.backoff.onReady=this.onBackoffReady.bind(this),(typeof r.connect>"u"||r.connect)&&this.open()}return e(i,[{key:"open",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;this.isReconnect=t;var r=this.ws&&this.ws.binaryType;this.ws=new o(this.url,this.protocols),this.ws.onclose=this.onCloseCallback.bind(this),this.ws.onerror=this.onErrorCallback.bind(this),this.ws.onmessage=this.onMessageCallback.bind(this),this.ws.onopen=this.onOpenCallback.bind(this),r&&(this.ws.binaryType=r)}},{key:"onBackoffReady",value:function(t,r){this.open(!0)}},{key:"onCloseCallback",value:function(t){!this.isReconnect&&this.listeners.onclose&&this.listeners.onclose.apply(null,arguments),this.reconnectEnabled&&t.code<3e3&&this.backoff.backoff()}},{key:"onErrorCallback",value:function(){this.listeners.onerror&&this.listeners.onerror.apply(null,arguments)}},{key:"onMessageCallback",value:function(){this.listeners.onmessage&&this.listeners.onmessage.apply(null,arguments)}},{key:"onOpenCallback",value:function(){this.listeners.onopen&&this.listeners.onopen.apply(null,arguments),this.isReconnect&&this.listeners.onreconnect&&this.listeners.onreconnect.apply(null,arguments),this.isReconnect=!1}},{key:"close",value:function(t,r){typeof t>"u"&&(t=1e3),this.reconnectEnabled=!1,this.ws.close(t,r)}},{key:"send",value:function(t){this.ws.send(t)}},{key:"bufferedAmount",get:function(){return this.ws.bufferedAmount}},{key:"readyState",get:function(){return this.ws.readyState}},{key:"binaryType",get:function(){return this.ws.binaryType},set:function(t){this.ws.binaryType=t}},{key:"extensions",get:function(){return this.ws.extensions},set:function(t){this.ws.extensions=t}},{key:"protocol",get:function(){return this.ws.protocol},set:function(t){this.ws.protocol=t}},{key:"onclose",set:function(t){this.listeners.onclose=t},get:function(){return this.listeners.onclose}},{key:"onerror",set:function(t){this.listeners.onerror=t},get:function(){return this.listeners.onerror}},{key:"onmessage",set:function(t){this.listeners.onmessage=t},get:function(){return this.listeners.onmessage}},{key:"onopen",set:function(t){this.listeners.onopen=t},get:function(){return this.listeners.onopen}},{key:"onreconnect",set:function(t){this.listeners.onreconnect=t},get:function(){return this.listeners.onreconnect}}]),i}();return c.CONNECTING=o.CONNECTING,c.OPEN=o.OPEN,c.CLOSING=o.CLOSING,c.CLOSED=o.CLOSED,d.default=c,d}var ne=ee();const g=N(ne);let b;const h=[],f={},te=e=>{h.push(e)},se=e=>{const s=h.indexOf(e);s!==-1&&h.splice(s,1)},E=({channelName:e,params:s,onConnect:a})=>{const o=k(e,s);f[o]=f[o]||0,f[o]===0&&b.send(JSON.stringify({type:"subscribe",stream:e,...s})),f[o]+=1,a()},O=({channelName:e,params:s,onDisconnect:a})=>{const o=k(e,s);f[o]=f[o]||1,f[o]===1&&b.readyState===g.OPEN&&b.send(JSON.stringify({type:"unsubscribe",stream:e,...s})),f[o]-=1,a()},oe={connected(){h.forEach(e=>E(e))},received(e){const{stream:s}=e;h.filter(({channelName:a,params:o})=>{const c=s[0];if(s.length===1)return a===c;const i=s[1];return["hashtag","hashtag:local"].includes(a)?a===c&&o.tag===i:a==="list"?a===c&&o.list===i:!1}).forEach(a=>{a.onReceive(e)})},disconnected(){h.forEach(e=>O(e))},reconnected(){}},k=(e,s)=>Object.keys(s).length===0?e:`${e}&${Object.keys(s).map(a=>`${a}=${s[a]}`).join("&")}`,ie=(e,s,a)=>(o,c)=>{const i=c().getIn(["meta","streaming_api_base_url"]),n=x(),{onConnect:t,onReceive:r,onDisconnect:l}=a(o,c);if(!n)throw new Error("Trying to connect to the streaming server but no access token is available.");if(!i.startsWith("ws")){const m=C(i,n,k(e,s),{connected(){t()},received(T){r(T)},disconnected(){l()},reconnected(){t()}});return()=>{m.close()}}const u={channelName:e,params:s,onConnect:t,onReceive:r,onDisconnect:l};return te(u),b?b.readyState===g.OPEN&&E(u):b=C(i,n,"",oe),()=>{se(u),O(u)}},ae=["update","delete","notification","conversation","filters_changed","announcement","announcement.delete","announcement.reaction"],re=(e,s)=>{s({event:e.type,payload:e.data})},C=(e,s,a,{connected:o,received:c,disconnected:i,reconnected:n})=>{const t=a.split("&");if(a=t.shift(),e.startsWith("ws")){const l=new g(`${e}/api/v1/streaming/?${t.join("&")}`,s);return l.onopen=o,l.onmessage=u=>c(JSON.parse(u.data)),l.onclose=i,l.onreconnect=n,l}a=a.replace(/:/g,"/"),a.endsWith(":media")&&(a=a.replace("/media",""),t.push("only_media=true")),t.push(`access_token=${s}`);const r=new EventSource(`${e}/api/v1/streaming/${a}?${t.join("&")}`);return r.onopen=()=>{o()},ae.forEach(l=>{r.addEventListener(l,u=>re(u,c))}),r.onerror=i,r},S=e=>Math.floor(Math.random()*Math.floor(e)),p=(e,s,a={},o={})=>{const{messages:c}=$();return ie(s,a,(i,n)=>{const t=n().getIn(["meta","locale"]);let r;const l=async u=>{await u(i,n),r=setTimeout(()=>l(u),2e4+S(2e4))};return{onConnect(){i(I(e)),r&&(clearTimeout(r),r=null),o.fillGaps&&i(o.fillGaps())},onDisconnect(){i(A({timeline:e})),o.fallback&&(r=setTimeout(()=>l(o.fallback),S(4e4)))},onReceive(u){switch(u.event){case"update":i(L(e,JSON.parse(u.payload),o.accept));break;case"status.update":i(D(JSON.parse(u.payload)));break;case"delete":i(W(u.payload));break;case"notification":{const m=JSON.parse(u.payload);i(J(m,c,t)),i(P(m));break}case"notifications_merged":{i(j());break}case"conversation":i(M(JSON.parse(u.payload)));break;case"announcement":i(B(JSON.parse(u.payload)));break;case"announcement.reaction":i(R(JSON.parse(u.payload)));break;case"announcement.delete":i(G(u.payload));break}}}})};async function ce(e){await e(K({maxId:void 0}));try{await e(U())}catch{}await e(V())}const pe=()=>p("home","user",{},{fallback:ce,fillGaps:q}),me=({onlyMedia:e}={})=>p(`community${e?":media":""}`,`public:local${e?":media":""}`,{},{fillGaps:()=>F({onlyMedia:e})}),de=({onlyMedia:e,onlyRemote:s}={})=>p(`public${s?":remote":""}${e?":media":""}`,`public${s?":remote":""}${e?":media":""}`,{},{fillGaps:()=>H({onlyMedia:e,onlyRemote:s})}),ye=(e,s,a,o)=>p(`hashtag:${e}${a?":local":""}`,`hashtag${a?":local":""}`,{tag:s},{accept:o}),ge=()=>p("direct","direct"),ke=e=>p(`list:${e}`,"list",{list:e},{fillGaps:()=>z(e)});export{de as a,me as b,pe as c,ye as d,ge as e,ke as f};
//# sourceMappingURL=streaming-DlYu2k3L.js.map
