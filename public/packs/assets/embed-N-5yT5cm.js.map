{"version":3,"file":"embed-N-5yT5cm.js","sources":["../../../app/javascript/mastodon/hooks/useRenderSignal.ts","../../../app/javascript/mastodon/features/standalone/status/index.tsx","../../../app/javascript/entrypoints/embed.tsx"],"sourcesContent":["// This hook allows a component to signal that it's done rendering in a way that\n// can be used by e.g. our embed code to determine correct iframe height\n\nlet renderSignalReceived = false;\n\ntype Callback = () => void;\n\nlet onInitialRender: Callback;\n\nexport const afterInitialRender = (callback: Callback) => {\n  if (renderSignalReceived) {\n    callback();\n  } else {\n    onInitialRender = callback;\n  }\n};\n\nexport const useRenderSignal = () => {\n  return () => {\n    if (renderSignalReceived) {\n      return;\n    }\n\n    renderSignalReceived = true;\n\n    if (typeof onInitialRender !== 'undefined') {\n      window.requestAnimationFrame(() => {\n        onInitialRender();\n      });\n    }\n  };\n};\n","/* eslint-disable @typescript-eslint/no-unsafe-return,\n                  @typescript-eslint/no-explicit-any,\n                  @typescript-eslint/no-unsafe-assignment */\n\nimport { useEffect, useCallback } from 'react';\n\nimport { Provider } from 'react-redux';\n\nimport { fetchStatus, toggleStatusSpoilers } from 'mastodon/actions/statuses';\nimport { hydrateStore } from 'mastodon/actions/store';\nimport { Router } from 'mastodon/components/router';\nimport { DetailedStatus } from 'mastodon/features/status/components/detailed_status';\nimport { useRenderSignal } from 'mastodon/hooks/useRenderSignal';\nimport initialState from 'mastodon/initial_state';\nimport { IntlProvider } from 'mastodon/locales';\nimport { makeGetStatus, makeGetPictureInPicture } from 'mastodon/selectors';\nimport { store, useAppSelector, useAppDispatch } from 'mastodon/store';\n\nconst getStatus = makeGetStatus() as unknown as (arg0: any, arg1: any) => any;\nconst getPictureInPicture = makeGetPictureInPicture() as unknown as (\n  arg0: any,\n  arg1: any,\n) => any;\n\nconst Embed: React.FC<{ id: string }> = ({ id }) => {\n  const status = useAppSelector((state) => getStatus(state, { id }));\n  const pictureInPicture = useAppSelector((state) =>\n    getPictureInPicture(state, { id }),\n  );\n  const domain = useAppSelector((state) => state.meta.get('domain'));\n  const dispatch = useAppDispatch();\n  const dispatchRenderSignal = useRenderSignal();\n\n  useEffect(() => {\n    dispatch(fetchStatus(id, false, false));\n  }, [dispatch, id]);\n\n  const handleToggleHidden = useCallback(() => {\n    dispatch(toggleStatusSpoilers(id));\n  }, [dispatch, id]);\n\n  // This allows us to calculate the correct page height for embeds\n  if (status) {\n    dispatchRenderSignal();\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-call, @typescript-eslint/no-unsafe-member-access\n  const permalink = status?.get('url') as string;\n\n  return (\n    <div className='embed'>\n      <DetailedStatus\n        status={status}\n        domain={domain}\n        pictureInPicture={pictureInPicture}\n        onToggleHidden={handleToggleHidden}\n        withLogo\n      />\n\n      <a\n        className='embed__overlay'\n        href={permalink}\n        target='_blank'\n        rel='noopener'\n        aria-label=''\n      />\n    </div>\n  );\n};\n\nexport const Status: React.FC<{ id: string }> = ({ id }) => {\n  useEffect(() => {\n    if (initialState) {\n      store.dispatch(hydrateStore(initialState));\n    }\n  }, []);\n\n  return (\n    <IntlProvider>\n      <Provider store={store}>\n        <Router>\n          <Embed id={id} />\n        </Router>\n      </Provider>\n    </IntlProvider>\n  );\n};\n","import { createRoot } from 'react-dom/client';\n\nimport { afterInitialRender } from 'mastodon/hooks/useRenderSignal';\n\nimport { Status } from '../mastodon/features/standalone/status';\nimport { loadPolyfills } from '../mastodon/polyfills';\nimport ready from '../mastodon/ready';\n\nfunction loaded() {\n  const mountNode = document.getElementById('mastodon-status');\n\n  if (mountNode) {\n    const attr = mountNode.getAttribute('data-props');\n\n    if (!attr) return;\n\n    const props = JSON.parse(attr) as { id: string; locale: string };\n    const root = createRoot(mountNode);\n\n    root.render(<Status {...props} />);\n  }\n}\n\nfunction main() {\n  ready(loaded).catch((error: unknown) => {\n    console.error(error);\n  });\n}\n\nloadPolyfills()\n  .then(main)\n  .catch((error: unknown) => {\n    console.error(error);\n  });\n\ninterface SetHeightMessage {\n  type: 'setHeight';\n  id: string;\n  height: number;\n}\n\nfunction isSetHeightMessage(data: unknown): data is SetHeightMessage {\n  if (\n    data &&\n    typeof data === 'object' &&\n    'type' in data &&\n    data.type === 'setHeight'\n  )\n    return true;\n  else return false;\n}\n\nwindow.addEventListener('message', (e) => {\n  // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition -- typings are not correct, it can be null in very rare cases\n  if (!e.data || !isSetHeightMessage(e.data) || !window.parent) return;\n\n  const data = e.data;\n\n  // Only set overflow to `hidden` once we got the expected `message` so the post can still be scrolled if\n  // embedded without parent Javascript support\n  document.body.style.overflow = 'hidden';\n\n  // We use a timeout to allow for the React page to render before calculating the height\n  afterInitialRender(() => {\n    window.parent.postMessage(\n      {\n        type: 'setHeight',\n        id: data.id,\n        height: document.getElementsByTagName('html')[0]?.scrollHeight,\n      },\n      '*',\n    );\n  });\n});\n"],"names":["renderSignalReceived","onInitialRender","afterInitialRender","callback","useRenderSignal","window","requestAnimationFrame","getStatus","makeGetStatus","getPictureInPicture","makeGetPictureInPicture","Embed","id","status","useAppSelector","state","pictureInPicture","domain","meta","get","dispatch","useAppDispatch","dispatchRenderSignal","useEffect","fetchStatus","handleToggleHidden","useCallback","toggleStatusSpoilers","permalink","jsxs","jsx","DetailedStatus","Status","initialState","store","hydrateStore","IntlProvider","Provider","Router","loaded","mountNode","document","getElementById","attr","getAttribute","props","JSON","parse","createRoot","render","main","ready","catch","error","console","loadPolyfills","then","isSetHeightMessage","data","type","addEventListener","e","parent","body","style","overflow","postMessage","height","getElementsByTagName","scrollHeight"],"mappings":"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"}