{"version":3,"file":"status_content-CaIN8-0B.js","sources":["../../app/javascript/mastodon/components/status_content.jsx"],"sourcesContent":["import PropTypes from 'prop-types';\nimport { PureComponent } from 'react';\n\nimport { FormattedMessage, injectIntl } from 'react-intl';\n\nimport classnames from 'classnames';\nimport { withRouter } from 'react-router-dom';\n\nimport ImmutablePropTypes from 'react-immutable-proptypes';\nimport { connect } from 'react-redux';\n\nimport ChevronRightIcon from '@/material-icons/400-24px/chevron_right.svg?react';\nimport { Icon }  from 'mastodon/components/icon';\nimport { Poll } from 'mastodon/components/poll';\nimport { identityContextPropShape, withIdentity } from 'mastodon/identity_context';\nimport { autoPlayGif, languages as preloadedLanguages } from 'mastodon/initial_state';\n\nconst MAX_HEIGHT = 706; // 22px * 32 (+ 2px padding at the top)\n\n/**\n *\n * @param {any} status\n * @returns {string}\n */\nexport function getStatusContent(status) {\n  return status.getIn(['translation', 'contentHtml']) || status.get('contentHtml');\n}\n\nclass TranslateButton extends PureComponent {\n\n  static propTypes = {\n    translation: ImmutablePropTypes.map,\n    onClick: PropTypes.func,\n  };\n\n  render () {\n    const { translation, onClick } = this.props;\n\n    if (translation) {\n      const language     = preloadedLanguages.find(lang => lang[0] === translation.get('detected_source_language'));\n      const languageName = language ? language[1] : translation.get('detected_source_language');\n      const provider     = translation.get('provider');\n\n      return (\n        <div className='translate-button'>\n          <div className='translate-button__meta'>\n            <FormattedMessage id='status.translated_from_with' defaultMessage='Translated from {lang} using {provider}' values={{ lang: languageName, provider }} />\n          </div>\n\n          <button className='link-button' onClick={onClick}>\n            <FormattedMessage id='status.show_original' defaultMessage='Show original' />\n          </button>\n        </div>\n      );\n    }\n\n    return (\n      <button className='status__content__translate-button' onClick={onClick}>\n        <FormattedMessage id='status.translate' defaultMessage='Translate' />\n      </button>\n    );\n  }\n\n}\n\nconst mapStateToProps = state => ({\n  languages: state.getIn(['server', 'translationLanguages', 'items']),\n});\n\nclass StatusContent extends PureComponent {\n  static propTypes = {\n    identity: identityContextPropShape,\n    status: ImmutablePropTypes.map.isRequired,\n    statusContent: PropTypes.string,\n    onTranslate: PropTypes.func,\n    onClick: PropTypes.func,\n    collapsible: PropTypes.bool,\n    onCollapsedToggle: PropTypes.func,\n    languages: ImmutablePropTypes.map,\n    intl: PropTypes.object,\n    // from react-router\n    match: PropTypes.object.isRequired,\n    location: PropTypes.object.isRequired,\n    history: PropTypes.object.isRequired\n  };\n\n  _updateStatusLinks () {\n    const node = this.node;\n\n    if (!node) {\n      return;\n    }\n\n    const { status, onCollapsedToggle } = this.props;\n    const links = node.querySelectorAll('a');\n\n    let link, mention;\n\n    for (var i = 0; i < links.length; ++i) {\n      link = links[i];\n\n      if (link.classList.contains('status-link')) {\n        continue;\n      }\n\n      link.classList.add('status-link');\n\n      mention = this.props.status.get('mentions').find(item => link.href === item.get('url'));\n\n      if (mention) {\n        link.addEventListener('click', this.onMentionClick.bind(this, mention), false);\n        link.setAttribute('title', `@${mention.get('acct')}`);\n        link.setAttribute('href', `/@${mention.get('acct')}`);\n        link.setAttribute('data-hover-card-account', mention.get('id'));\n      } else if (link.textContent[0] === '#' || (link.previousSibling && link.previousSibling.textContent && link.previousSibling.textContent[link.previousSibling.textContent.length - 1] === '#')) {\n        link.addEventListener('click', this.onHashtagClick.bind(this, link.text), false);\n        link.setAttribute('href', `/tags/${link.text.replace(/^#/, '')}`);\n        link.setAttribute('data-menu-hashtag', this.props.status.getIn(['account', 'id']));\n      } else {\n        link.setAttribute('title', link.href);\n        link.classList.add('unhandled-link');\n      }\n    }\n\n    if (status.get('collapsed', null) === null && onCollapsedToggle) {\n      const { collapsible, onClick } = this.props;\n\n      const collapsed =\n          collapsible\n          && onClick\n          && node.clientHeight > MAX_HEIGHT\n          && status.get('spoiler_text').length === 0;\n\n      onCollapsedToggle(collapsed);\n    }\n  }\n\n  handleMouseEnter = ({ currentTarget }) => {\n    if (autoPlayGif) {\n      return;\n    }\n\n    const emojis = currentTarget.querySelectorAll('.custom-emoji');\n\n    for (var i = 0; i < emojis.length; i++) {\n      let emoji = emojis[i];\n      emoji.src = emoji.getAttribute('data-original');\n    }\n  };\n\n  handleMouseLeave = ({ currentTarget }) => {\n    if (autoPlayGif) {\n      return;\n    }\n\n    const emojis = currentTarget.querySelectorAll('.custom-emoji');\n\n    for (var i = 0; i < emojis.length; i++) {\n      let emoji = emojis[i];\n      emoji.src = emoji.getAttribute('data-static');\n    }\n  };\n\n  componentDidMount () {\n    this._updateStatusLinks();\n  }\n\n  componentDidUpdate () {\n    this._updateStatusLinks();\n  }\n\n  onMentionClick = (mention, e) => {\n    if (this.props.history && e.button === 0 && !(e.ctrlKey || e.metaKey)) {\n      e.preventDefault();\n      this.props.history.push(`/@${mention.get('acct')}`);\n    }\n  };\n\n  onHashtagClick = (hashtag, e) => {\n    hashtag = hashtag.replace(/^#/, '');\n\n    if (this.props.history && e.button === 0 && !(e.ctrlKey || e.metaKey)) {\n      e.preventDefault();\n      this.props.history.push(`/tags/${hashtag}`);\n    }\n  };\n\n  handleMouseDown = (e) => {\n    this.startXY = [e.clientX, e.clientY];\n  };\n\n  handleMouseUp = (e) => {\n    if (!this.startXY) {\n      return;\n    }\n\n    const [ startX, startY ] = this.startXY;\n    const [ deltaX, deltaY ] = [Math.abs(e.clientX - startX), Math.abs(e.clientY - startY)];\n\n    let element = e.target;\n    while (element) {\n      if (element.localName === 'button' || element.localName === 'a' || element.localName === 'label') {\n        return;\n      }\n      element = element.parentNode;\n    }\n\n    if (deltaX + deltaY < 5 && (e.button === 0 || e.button === 1) && e.detail >= 1 && this.props.onClick) {\n      this.props.onClick(e);\n    }\n\n    this.startXY = null;\n  };\n\n  handleTranslate = () => {\n    this.props.onTranslate();\n  };\n\n  setRef = (c) => {\n    this.node = c;\n  };\n\n  render () {\n    const { status, intl, statusContent } = this.props;\n\n    const renderReadMore = this.props.onClick && status.get('collapsed');\n    const contentLocale = intl.locale.replace(/[_-].*/, '');\n    const targetLanguages = this.props.languages?.get(status.get('language') || 'und');\n    const renderTranslate = this.props.onTranslate && this.props.identity.signedIn && ['public', 'unlisted'].includes(status.get('visibility')) && status.get('search_index').trim().length > 0 && targetLanguages?.includes(contentLocale);\n\n    const content = { __html: statusContent ?? getStatusContent(status) };\n    const language = status.getIn(['translation', 'language']) || status.get('language');\n    const classNames = classnames('status__content', {\n      'status__content--with-action': this.props.onClick && this.props.history,\n      'status__content--collapsed': renderReadMore,\n    });\n\n    const readMoreButton = renderReadMore && (\n      <button className='status__content__read-more-button' onClick={this.props.onClick} key='read-more'>\n        <FormattedMessage id='status.read_more' defaultMessage='Read more' /><Icon id='angle-right' icon={ChevronRightIcon} />\n      </button>\n    );\n\n    const translateButton = renderTranslate && (\n      <TranslateButton onClick={this.handleTranslate} translation={status.get('translation')} />\n    );\n\n    const poll = !!status.get('poll') && (\n      <Poll pollId={status.get('poll')} status={status} lang={language} />\n    );\n\n    if (this.props.onClick) {\n      return (\n        <>\n          <div className={classNames} ref={this.setRef} onMouseDown={this.handleMouseDown} onMouseUp={this.handleMouseUp} key='status-content' onMouseEnter={this.handleMouseEnter} onMouseLeave={this.handleMouseLeave}>\n            <div className='status__content__text status__content__text--visible translate' lang={language} dangerouslySetInnerHTML={content} />\n\n            {poll}\n            {translateButton}\n          </div>\n\n          {readMoreButton}\n        </>\n      );\n    } else {\n      return (\n        <div className={classNames} ref={this.setRef} onMouseEnter={this.handleMouseEnter} onMouseLeave={this.handleMouseLeave}>\n          <div className='status__content__text status__content__text--visible translate' lang={language} dangerouslySetInnerHTML={content} />\n\n          {poll}\n          {translateButton}\n        </div>\n      );\n    }\n  }\n\n}\n\nexport default withRouter(withIdentity(connect(mapStateToProps)(injectIntl(StatusContent))));\n"],"names":["MAX_HEIGHT","getStatusContent","status","getIn","get","TranslateButton","PureComponent","render","translation","onClick","props","language","preloadedLanguages","find","lang","languageName","provider","jsxs","jsx","FormattedMessage","mapStateToProps","state","languages","StatusContent","handleMouseEnter","currentTarget","autoPlayGif","emojis","querySelectorAll","i","length","emoji","src","getAttribute","handleMouseLeave","onMentionClick","mention","e","history","button","ctrlKey","metaKey","preventDefault","push","onHashtagClick","hashtag","replace","handleMouseDown","startXY","clientX","clientY","handleMouseUp","startX","startY","deltaX","deltaY","Math","abs","element","target","localName","parentNode","detail","handleTranslate","onTranslate","setRef","c","node","_updateStatusLinks","onCollapsedToggle","links","link","classList","contains","add","item","href","addEventListener","bind","setAttribute","textContent","previousSibling","text","collapsible","collapsed","clientHeight","componentDidMount","componentDidUpdate","intl","statusContent","renderReadMore","contentLocale","locale","targetLanguages","_a","renderTranslate","identity","signedIn","includes","trim","content","__html","classNames","classnames","readMoreButton","Icon","ChevronRightIcon","translateButton","poll","Poll","Fragment","StatusContent$1","withRouter","withIdentity","connect","injectIntl"],"mappings":"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"}