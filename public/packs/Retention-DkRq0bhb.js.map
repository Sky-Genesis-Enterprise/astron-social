{"version":3,"file":"Retention-DkRq0bhb.js","sources":["../../app/javascript/mastodon/components/admin/Retention.jsx"],"sourcesContent":["import PropTypes from 'prop-types';\nimport { PureComponent } from 'react';\n\nimport { FormattedMessage, FormattedNumber, FormattedDate } from 'react-intl';\n\nimport classNames from 'classnames';\n\nimport api from 'mastodon/api';\nimport { roundTo10 } from 'mastodon/utils/numbers';\n\nconst dateForCohort = cohort => {\n  const timeZone = 'UTC';\n  switch(cohort.frequency) {\n  case 'day':\n    return <FormattedDate value={cohort.period} month='long' day='2-digit' timeZone={timeZone} />;\n  default:\n    return <FormattedDate value={cohort.period} month='long' year='numeric' timeZone={timeZone} />;\n  }\n};\n\nexport default class Retention extends PureComponent {\n\n  static propTypes = {\n    start_at: PropTypes.string,\n    end_at: PropTypes.string,\n    frequency: PropTypes.string,\n  };\n\n  state = {\n    loading: true,\n    data: null,\n  };\n\n  componentDidMount () {\n    const { start_at, end_at, frequency } = this.props;\n\n    api(false).post('/api/v1/admin/retention', { start_at, end_at, frequency }).then(res => {\n      this.setState({\n        loading: false,\n        data: res.data,\n      });\n    }).catch(err => {\n      console.error(err);\n    });\n  }\n\n  render () {\n    const { loading, data } = this.state;\n    const { frequency } = this.props;\n\n    let content;\n\n    if (loading) {\n      content = <FormattedMessage id='loading_indicator.label' defaultMessage='Loadingâ€¦' />;\n    } else {\n      content = (\n        <table className='retention__table'>\n          <thead>\n            <tr>\n              <th>\n                <div className='retention__table__date retention__table__label'>\n                  <FormattedMessage id='admin.dashboard.retention.cohort' defaultMessage='Sign-up month' />\n                </div>\n              </th>\n\n              <th>\n                <div className='retention__table__number retention__table__label'>\n                  <FormattedMessage id='admin.dashboard.retention.cohort_size' defaultMessage='New users' />\n                </div>\n              </th>\n\n              {data[0].data.slice(1).map((retention, i) => (\n                <th key={retention.date}>\n                  <div className='retention__table__number retention__table__label'>\n                    {i + 1}\n                  </div>\n                </th>\n              ))}\n            </tr>\n\n            <tr>\n              <td>\n                <div className='retention__table__date retention__table__average'>\n                  <FormattedMessage id='admin.dashboard.retention.average' defaultMessage='Average' />\n                </div>\n              </td>\n\n              <td>\n                <div className='retention__table__size'>\n                  <FormattedNumber value={data.reduce((sum, cohort, i) => sum + ((cohort.data[0].value * 1) - sum) / (i + 1), 0)} maximumFractionDigits={0} />\n                </div>\n              </td>\n\n              {data[0].data.slice(1).map((retention, i) => {\n                const average = data.reduce((sum, cohort, k) => cohort.data[i + 1] ? sum + (cohort.data[i + 1].rate - sum)/(k + 1) : sum, 0);\n\n                return (\n                  <td key={retention.date}>\n                    <div className={classNames('retention__table__box', 'retention__table__average', `retention__table__box--${roundTo10(average * 100)}`)}>\n                      <FormattedNumber value={average} style='percent' />\n                    </div>\n                  </td>\n                );\n              })}\n            </tr>\n          </thead>\n\n          <tbody>\n            {data.slice(0, -1).map(cohort => (\n              <tr key={cohort.period}>\n                <td>\n                  <div className='retention__table__date'>\n                    {dateForCohort(cohort)}\n                  </div>\n                </td>\n\n                <td>\n                  <div className='retention__table__size'>\n                    <FormattedNumber value={cohort.data[0].value} />\n                  </div>\n                </td>\n\n                {cohort.data.slice(1).map(retention => (\n                  <td key={retention.date}>\n                    <div className={classNames('retention__table__box', `retention__table__box--${roundTo10(retention.rate * 100)}`)}>\n                      <FormattedNumber value={retention.rate} style='percent' />\n                    </div>\n                  </td>\n                ))}\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      );\n    }\n\n    let title = null;\n    switch(frequency) {\n    case 'day':\n      title = <FormattedMessage id='admin.dashboard.daily_retention' defaultMessage='User retention rate by day after sign-up' />;\n      break;\n    default:\n      title = <FormattedMessage id='admin.dashboard.monthly_retention' defaultMessage='User retention rate by month after sign-up' />;\n    }\n\n    return (\n      <div className='retention'>\n        <h4>{title}</h4>\n\n        {content}\n      </div>\n    );\n  }\n\n}\n"],"names":["dateForCohort","cohort","timeZone","frequency","jsx","FormattedDate","period","Retention","PureComponent","state","loading","data","componentDidMount","start_at","end_at","props","api","post","then","res","setState","catch","err","console","error","render","content","FormattedMessage","jsxs","slice","map","retention","i","date","FormattedNumber","reduce","sum","value","average","k","rate","classNames","roundTo10","title"],"mappings":"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"}