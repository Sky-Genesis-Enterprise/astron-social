import{j as e}from"./client-wT6vtYO_.js";import{g as Y,r,u as J,d as Q}from"./index-BdTwX--g.js";import{c as D}from"./index-DizoKcfL.js";import{a as Z}from"./toString-Cy1Ecq9L.js";import{c as ee}from"./index.module-sM2fS0Fl.js";import{S as te}from"./insert_chart-BTwnuSdd.js";import{S as ae}from"./person_add-Bq7Kcwwn.js";import{u as se,a as O,ak as oe,o as ne,I as b,w as re,ab as ie,aT as le}from"./useSelectableClick-DeaJbL2_.js";import{d as ce}from"./api-B2m7efUy.js";import{B as ue}from"./index-BZWHsOPk.js";import{d as de,a as A,r as me}from"./initial_state-BP3UcUr4.js";import{M as u}from"./message-UFwkQlnu.js";import"./index-CAH5FfLP.js";import"./ready-DpOgoWSg.js";import"./short_number-WomMu2iV.js";import"./numbers-CGZQWBYL.js";import"./load_locale-tOpKhmcM.js";import"./index-lj9VQs0f.js";var C,U;function pe(){if(U)return C;U=1;var t=Z(),s=/[\\^$.*+?()[\]{}|]/g,n=RegExp(s.source);function d(p){return p=t(p),p&&n.test(p)?p.replace(s,"\\$&"):p}return C=d,C}var fe=pe();const ge=Y(fe),F=Q({loginPrompt:{id:"interaction_modal.username_prompt",defaultMessage:"E.g. {example}"}}),P="mastodon_home",V="username@mastodon.social",he=t=>{const s=new URL("https:///path");return s.hostname=t,s.hostname===t},E=t=>{if(/^https?:\/\//.test(t))try{return new URL(t).host}catch{return null}else if(t.includes("@")){const[s,n,...d]=t.replace(/^@/,"").split("@");return!n||d.length>0?null:E(n)}return t},q=(t,s)=>(t=t.trim(),t.includes(".")&&he(t)?[t].concat(s.filter(n=>n!==t)):s),xe=t=>{let s=!1,n=null;if(t.startsWith("/"))return!1;if(t.startsWith("@")&&(t=t.slice(1),s=!0),t==="")return!0;/^https?:\/\//.test(t)&&!s?n=t:n=`https://${t}`;try{return new URL(n),!0}catch{return!1}},k=(t,s)=>{var n;if(E(s.trim())===de){window.location.href="/auth/sign_in";return}(n=t==null?void 0:t.contentWindow)==null||n.postMessage({type:"fetchInteractionURL",uri_or_domain:s.trim()},window.origin)},_e=({resourceUrl:t})=>{const s=J(),[n,d]=r.useState(localStorage.getItem(P)??""),[p,j]=r.useState(!1),[f,x]=r.useState(-1),[h,l]=r.useState(!1),[g,c]=r.useState(!1),[m,_]=r.useState([]),[v,I]=r.useState([]),[B,T]=r.useState(!1),W=r.useRef(null),w=r.useRef(null),y=r.useRef(null);r.useEffect(()=>{const o=a=>{var i;if(!(a.origin!==window.origin||a.source!==((i=w.current)==null?void 0:i.contentWindow))){if(a.data.type==="fetchInteractionURL-failure")l(!1),c(!0);else if(a.data.type==="fetchInteractionURL-success")if(a.data.template&&/^https?:\/\//.test(a.data.template))try{const R=new URL(a.data.template.replace("{uri}",encodeURIComponent(t)));localStorage.setItem(P,a.data.uri_or_domain),window.location.href=R.toString()}catch{l(!1),c(!0)}else l(!1),c(!0)}};return window.addEventListener("message",o),()=>{window.removeEventListener("message",o)}},[t,l,c]);const N=ee(o=>{y.current&&y.current.abort();const a=E(o.trim());if(a===null||a.length===0){_([]),I([]);return}y.current=new AbortController,ce("GET","v1/peers/search",{signal:y.current.signal,params:{q:a}}).then(i=>(I(i??[]),_(q(o,i??[])),"")).catch(()=>{})},500,{leading:!0,trailing:!0}),$=r.useCallback(({target:{value:o}})=>{d(o),T(!0),c(!xe(o)),_(q(o,v)),N(o)},[c,d,T,_,v,N]),S=r.useCallback(()=>{l(!0),k(w.current,n)},[l,n]),G=r.useCallback(()=>{j(!0)},[j]),H=r.useCallback(()=>{j(!1)},[j]),K=r.useCallback(o=>{const a=m[f];switch(o.key){case"ArrowDown":o.preventDefault(),m.length>0&&x(i=>Math.min(i+1,m.length-1));break;case"ArrowUp":o.preventDefault(),m.length>0&&x(i=>Math.max(i-1,-1));break;case"Enter":o.preventDefault(),f===-1?S():m.length>0&&a&&(c(!1),d(a),l(!0),k(w.current,a));break}},[S,x,c,d,f,m]),z=r.useCallback(o=>{o.preventDefault();const a=Number(o.currentTarget.getAttribute("data-index")),i=m[a];i&&(x(a),d(i),c(!1),l(!0),k(w.current,i))},[m,x,d,c]),M=(E(n)??"").trim(),X=new RegExp(`(${ge(M)})`,"gi"),L=B&&M.length>0&&m.length>0;return e.jsxs("div",{className:D("interaction-modal__login",{focused:p,expanded:L,invalid:g}),children:[e.jsx("iframe",{ref:w,style:{display:"none"},src:"/remote_interaction_helper",sandbox:"allow-scripts allow-same-origin",title:"remote interaction helper"}),e.jsxs("div",{className:"interaction-modal__login__input",children:[e.jsx("input",{ref:W,type:"text",value:n,placeholder:s.formatMessage(F.loginPrompt,{example:V}),"aria-label":s.formatMessage(F.loginPrompt,{example:V}),autoFocus:!0,onChange:$,onFocus:G,onBlur:H,onKeyDown:K,autoComplete:"off",autoCapitalize:"off",spellCheck:"false"}),e.jsx(ue,{onClick:S,disabled:h||g,children:e.jsx(u,{id:"interaction_modal.go",defaultMessage:"Go"})})]}),L&&e.jsx("div",{className:"search__popout",children:e.jsx("div",{className:"search__popout__menu",children:m.map((o,a)=>e.jsx("button",{onMouseDown:z,"data-index":a,className:D("search__popout__menu__item",{selected:f===a}),children:o.split(X).map((i,R)=>i.toLowerCase()===M.toLowerCase()?e.jsx("mark",{children:i},R):e.jsx("span",{children:i},R))},o))})})]})},Ue=({accountId:t,url:s,type:n})=>{const d=se(),p=O(m=>{var _;return((_=m.accounts.get(t))==null?void 0:_.display_name_html)??""}),j=O(m=>m.server.getIn(["server","registrations","url"],null)||"/auth/sign_up"),f=e.jsx("bdi",{dangerouslySetInnerHTML:{__html:p}}),x=r.useCallback(()=>{d(oe({modalType:void 0,ignoreFocus:!1})),d(ne({modalType:"CLOSED_REGISTRATIONS",modalProps:{}}))},[d]);let h,l,g;switch(n){case"reply":l=e.jsx(b,{id:"reply",icon:le}),h=e.jsx(u,{id:"interaction_modal.title.reply",defaultMessage:"Reply to {name}'s post",values:{name:f}}),g=e.jsx(u,{id:"interaction_modal.action.reply",defaultMessage:"To continue, you need to reply from your account."});break;case"reblog":l=e.jsx(b,{id:"retweet",icon:ie}),h=e.jsx(u,{id:"interaction_modal.title.reblog",defaultMessage:"Boost {name}'s post",values:{name:f}}),g=e.jsx(u,{id:"interaction_modal.action.reblog",defaultMessage:"To continue, you need to reblog from your account."});break;case"favourite":l=e.jsx(b,{id:"star",icon:re}),h=e.jsx(u,{id:"interaction_modal.title.favourite",defaultMessage:"Favorite {name}'s post",values:{name:f}}),g=e.jsx(u,{id:"interaction_modal.action.favourite",defaultMessage:"To continue, you need to favorite from your account."});break;case"follow":l=e.jsx(b,{id:"user-plus",icon:ae}),h=e.jsx(u,{id:"interaction_modal.title.follow",defaultMessage:"Follow {name}",values:{name:f}}),g=e.jsx(u,{id:"interaction_modal.action.follow",defaultMessage:"To continue, you need to follow from your account."});break;case"vote":l=e.jsx(b,{id:"tasks",icon:te}),h=e.jsx(u,{id:"interaction_modal.title.vote",defaultMessage:"Vote in {name}'s poll",values:{name:f}}),g=e.jsx(u,{id:"interaction_modal.action.vote",defaultMessage:"To continue, you need to vote from your account."});break}let c;return A?c=e.jsx("a",{href:A,"data-method":"post",className:"link-button",children:e.jsx(u,{id:"sign_in_banner.create_account",defaultMessage:"Create account"})}):me?c=e.jsx("a",{href:j,className:"link-button",children:e.jsx(u,{id:"sign_in_banner.create_account",defaultMessage:"Create account"})}):c=e.jsx("button",{className:"link-button",onClick:x,children:e.jsx(u,{id:"sign_in_banner.create_account",defaultMessage:"Create account"})}),e.jsxs("div",{className:"modal-root__modal interaction-modal",children:[e.jsxs("div",{className:"interaction-modal__lead",children:[e.jsxs("h3",{children:[e.jsx("span",{className:"interaction-modal__icon",children:l})," ",h]}),e.jsx("p",{children:g})]}),e.jsx(_e,{resourceUrl:s}),e.jsxs("p",{children:[e.jsx(u,{id:"interaction_modal.no_account_yet",defaultMessage:"Don't have an account yet?"})," ",c]})]})};export{Ue as default};
//# sourceMappingURL=interaction_modal-index-BoWxizj8.js.map
