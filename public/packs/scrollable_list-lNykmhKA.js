var P=Object.defineProperty;var w=(n,s,e)=>s in n?P(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var i=(n,s,e)=>w(n,typeof s!="symbol"?s+"":s,e);import{j as r}from"./client-wT6vtYO_.js";import{r as c}from"./index-BdTwX--g.js";import{c as S}from"./index-DizoKcfL.js";import{j as H,cI as B,cJ as D,cK as F,cL as N,bX as _,bT as A}from"./useSelectableClick-DeaJbL2_.js";import{a as b}from"./index-CAH5FfLP.js";import{S as K}from"./scroll_container-Bq73vRM7.js";import{s as C}from"./schedule_idle_task-Co3Ydhdu.js";import{L as U}from"./load_more-qGthrhsi.js";import{M as $}from"./message-UFwkQlnu.js";import{L as z}from"./loading_indicator-7xMB1U6D.js";import{u as J}from"./short_number-WomMu2iV.js";let M;function X(n){if(typeof M!="boolean"){const s=n.target.getBoundingClientRect(),e=n.boundingClientRect;M=s.height!==e.height||s.top!==e.top||s.width!==e.width||s.bottom!==e.bottom||s.left!==e.left||s.right!==e.right}return M?n.target.getBoundingClientRect():n.boundingClientRect}const Y=["id","index","listLength","cachedHeight"];class q extends c.Component{constructor(){super(...arguments);i(this,"state",{isHidden:!1});i(this,"handleIntersection",e=>{this.entry=e,C(this.calculateHeight),this.setState(this.updateStateAfterIntersection)});i(this,"updateStateAfterIntersection",e=>(e.isIntersecting!==!1&&!this.entry.isIntersecting&&C(this.hideIfNotIntersecting),{isIntersecting:this.entry.isIntersecting,isHidden:!1}));i(this,"calculateHeight",()=>{const{onHeightChange:e,saveHeightKey:t,id:o}=this.props;this.height=X(this.entry).height,e&&t&&e(t,o,this.height)});i(this,"hideIfNotIntersecting",()=>{this.componentMounted&&this.setState(e=>({isHidden:!e.isIntersecting}))});i(this,"handleRef",e=>{this.node=e})}shouldComponentUpdate(e,t){const o=!this.state.isIntersecting&&(this.state.isHidden||this.props.cachedHeight),l=!t.isIntersecting&&(t.isHidden||e.cachedHeight);return!!o!=!!l?!0:o?!Y.every(h=>e[h]===this.props[h]):!0}componentDidMount(){const{intersectionObserverWrapper:e,id:t}=this.props;e.observe(t,this.node,this.handleIntersection),this.componentMounted=!0}componentWillUnmount(){const{intersectionObserverWrapper:e,id:t}=this.props;e.unobserve(t,this.node),this.componentMounted=!1}render(){const{children:e,id:t,index:o,listLength:l,cachedHeight:h}=this.props,{isIntersecting:a,isHidden:d}=this.state;return!a&&(d||h)?r.jsx("article",{ref:this.handleRef,"aria-posinset":o+1,"aria-setsize":l,style:{height:`${this.height||h}px`,opacity:0,overflow:"hidden"},"data-id":t,tabIndex:-1,children:e&&c.cloneElement(e,{hidden:!0})}):r.jsx("article",{ref:this.handleRef,"aria-posinset":o+1,"aria-setsize":l,"data-id":t,tabIndex:-1,children:e&&c.cloneElement(e,{hidden:!1})})}}const G=(n,s)=>({cachedHeight:n.getIn(["height_cache",s.saveHeightKey,s.id])}),Q=n=>({onHeightChange(s,e,t){n(B(s,e,t))}}),V=H(G,Q)(q);class Z{constructor(){i(this,"callbacks",{});i(this,"observerBacklog",[]);i(this,"observer",null)}connect(s){const e=t=>{t.forEach(o=>{const l=o.target.getAttribute("data-id");this.callbacks[l]&&this.callbacks[l](o)})};this.observer=new IntersectionObserver(e,s),this.observerBacklog.forEach(([t,o,l])=>{this.observe(t,o,l)}),this.observerBacklog=null}observe(s,e,t){this.observer?(this.callbacks[s]=t,this.observer.observe(e)):this.observerBacklog.push([s,e,t])}unobserve(s,e){this.observer&&(delete this.callbacks[s],this.observer.unobserve(e))}disconnect(){this.observer&&(this.callbacks={},this.observer.disconnect(),this.observer=null)}}const ee=({onClick:n,count:s})=>r.jsx("button",{className:"load-more load-gap",onClick:n,children:r.jsx($,{id:"load_pending",defaultMessage:"{count, plural, one {# new item} other {# new items}}",values:{count:s}})}),I=300,u=A?{passive:!0}:!1,te=(n,{scrollKey:s})=>({preventScroll:s===n.dropdownMenu.scrollKey}),se=({id:n,index:s,listLength:e,intersectionObserverWrapper:t,trackScroll:o,scrollKey:l,children:h})=>{const a=J();return r.jsx(V,{id:n,index:s,listLength:e,intersectionObserverWrapper:t,saveHeightKey:o?`${a.key}:${l}`:null,children:h})};class x extends c.PureComponent{constructor(){super(...arguments);i(this,"state",{fullscreen:null,cachedMediaWidth:250});i(this,"intersectionObserverWrapper",new Z);i(this,"handleScroll",b(()=>{if(this.node){const e=this.getScrollTop(),t=this.getScrollHeight(),o=this.getClientHeight(),l=t-e-o;e>0&&l<400&&this.props.onLoadMore&&this.props.hasMore&&!this.props.isLoading&&this.props.onLoadMore(),e<100&&this.props.onScrollToTop?this.props.onScrollToTop():this.props.onScroll&&this.props.onScroll(),this.lastScrollWasSynthetic||(this.scrollToTopOnMouseIdle=!1),this.lastScrollWasSynthetic=!1}},150,{trailing:!0}));i(this,"mouseIdleTimer",null);i(this,"mouseMovedRecently",!1);i(this,"lastScrollWasSynthetic",!1);i(this,"scrollToTopOnMouseIdle",!1);i(this,"_getScrollingElement",()=>this.props.bindToDocument?document.scrollingElement||document.body:this.node);i(this,"setScrollTop",e=>{this.getScrollTop()!==e&&(this.lastScrollWasSynthetic=!0,this._getScrollingElement().scrollTop=e)});i(this,"clearMouseIdleTimer",()=>{this.mouseIdleTimer!==null&&(clearTimeout(this.mouseIdleTimer),this.mouseIdleTimer=null)});i(this,"handleMouseMove",b(()=>{this.clearMouseIdleTimer(),this.mouseIdleTimer=setTimeout(this.handleMouseIdle,I),!this.mouseMovedRecently&&this.getScrollTop()===0&&(this.scrollToTopOnMouseIdle=!0),this.mouseMovedRecently=!0},I/2));i(this,"handleWheel",b(()=>{this.scrollToTopOnMouseIdle=!1},150,{trailing:!0}));i(this,"handleMouseIdle",()=>{this.scrollToTopOnMouseIdle&&!this.props.preventScroll&&this.setScrollTop(0),this.mouseMovedRecently=!1,this.scrollToTopOnMouseIdle=!1});i(this,"getScrollPosition",()=>this.node&&(this.getScrollTop()>0||this.mouseMovedRecently)?{height:this.getScrollHeight(),top:this.getScrollTop()}:null);i(this,"getScrollTop",()=>this._getScrollingElement().scrollTop);i(this,"getScrollHeight",()=>this._getScrollingElement().scrollHeight);i(this,"getClientHeight",()=>this._getScrollingElement().clientHeight);i(this,"updateScrollBottom",e=>{const t=this.getScrollHeight()-e;this.setScrollTop(t)});i(this,"cacheMediaWidth",e=>{e&&this.state.cachedMediaWidth!==e&&this.setState({cachedMediaWidth:e})});i(this,"onFullScreenChange",()=>{this.setState({fullscreen:N()})});i(this,"setRef",e=>{this.node=e});i(this,"handleLoadMore",e=>{e.preventDefault(),this.props.onLoadMore()});i(this,"handleLoadPending",e=>{e.preventDefault(),this.props.onLoadPending(),this.scrollToTopOnMouseIdle=!1,this.lastScrollWasSynthetic=!1,this.clearMouseIdleTimer(),this.mouseIdleTimer=setTimeout(this.handleMouseIdle,I),this.mouseMovedRecently=!0})}componentDidMount(){this.attachScrollListener(),this.attachIntersectionObserver(),D(this.onFullScreenChange),this.handleScroll()}getSnapshotBeforeUpdate(e){const t=c.Children.count(e.children)>0&&c.Children.count(e.children)<c.Children.count(this.props.children)&&this.getFirstChildKey(e)!==this.getFirstChildKey(this.props);return e.numPending>0!=this.props.numPending>0||t&&(this.getScrollTop()>0||this.mouseMovedRecently||this.props.preventScroll)?this.getScrollHeight()-this.getScrollTop():null}componentDidUpdate(e,t,o){o!==null&&this.setScrollTop(this.getScrollHeight()-o)}componentWillUnmount(){this.clearMouseIdleTimer(),this.detachScrollListener(),this.detachIntersectionObserver(),F(this.onFullScreenChange)}attachIntersectionObserver(){let e={root:this.node,rootMargin:"300% 0px"};this.intersectionObserverWrapper.connect(this.props.bindToDocument?{}:e)}detachIntersectionObserver(){this.intersectionObserverWrapper.disconnect()}attachScrollListener(){this.props.bindToDocument?(document.addEventListener("scroll",this.handleScroll),document.addEventListener("wheel",this.handleWheel,u)):(this.node.addEventListener("scroll",this.handleScroll),this.node.addEventListener("wheel",this.handleWheel,u))}detachScrollListener(){this.props.bindToDocument?(document.removeEventListener("scroll",this.handleScroll),document.removeEventListener("wheel",this.handleWheel,u)):(this.node.removeEventListener("scroll",this.handleScroll),this.node.removeEventListener("wheel",this.handleWheel,u))}getFirstChildKey(e){const{children:t}=e;let o=t;return t instanceof _?o=t.get(0):Array.isArray(t)&&(o=t[0]),o&&o.key}render(){const{children:e,scrollKey:t,className:o,trackScroll:l,showLoading:h,isLoading:a,hasMore:d,numPending:g,prepend:m,alwaysPrepend:W,append:O,footer:f,emptyMessage:T,onLoadMore:E}=this.props,{fullscreen:L}=this.state,y=c.Children.count(e),R=d&&E?r.jsx(U,{visible:!a,onClick:this.handleLoadMore}):null,j=g>0?r.jsx(ee,{count:g,onClick:this.handleLoadPending}):null;let p=null;return h?p=r.jsxs("div",{className:"scrollable scrollable--flex",ref:this.setRef,children:[m,r.jsx("div",{role:"feed",className:"item-list"}),r.jsx("div",{className:"scrollable__append",children:r.jsx(z,{})}),f]}):a||y>0||g>0||d||!T?p=r.jsxs("div",{className:S("scrollable scrollable--flex",{fullscreen:L}),ref:this.setRef,onMouseMove:this.handleMouseMove,children:[m,r.jsxs("div",{role:"feed",className:S("item-list",o),children:[j,c.Children.map(this.props.children,(v,k)=>r.jsx(se,{id:v.key,index:k,listLength:y,intersectionObserverWrapper:this.intersectionObserverWrapper,trackScroll:l,scrollKey:t,children:c.cloneElement(v,{getScrollPosition:this.getScrollPosition,updateScrollBottom:this.updateScrollBottom,cachedMediaWidth:this.state.cachedMediaWidth,cacheMediaWidth:this.cacheMediaWidth})},v.key)),R,!d&&O]}),f]}):p=r.jsxs("div",{className:S("scrollable scrollable--flex",{fullscreen:L}),ref:this.setRef,children:[W&&m,r.jsx("div",{className:"empty-column-indicator",children:T}),f]}),l?r.jsx(K,{scrollKey:t,children:p}):p}}i(x,"defaultProps",{trackScroll:!0});const me=H(te,null,null,{forwardRef:!0})(x);export{me as S};
//# sourceMappingURL=scrollable_list-lNykmhKA.js.map
